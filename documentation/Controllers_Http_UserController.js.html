<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controllers/Http/UserController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="Controllers.Http.AssetController.html">Controllers.Http.AssetController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#allDaily">allDaily</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#byStrategy">byStrategy</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#sufficient">sufficient</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#total">total</a></li></ul></li><li><a href="Controllers.Http.ChatController.html">Controllers.Http.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ChatController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.ExchangeController.html">Controllers.Http.ExchangeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#USDTBalance">USDTBalance</a></li></ul></li><li><a href="Controllers.Http.PositionController.html">Controllers.Http.PositionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#current">current</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#performance">performance</a></li></ul></li><li><a href="Controllers.Http.SettingController.html">Controllers.Http.SettingController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#post">post</a></li></ul></li><li><a href="Controllers.Http.StrategyController.html">Controllers.Http.StrategyController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#isActive">isActive</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#userStrategyInfo">userStrategyInfo</a></li></ul></li><li><a href="Controllers.Http.SubscriptionController.html">Controllers.Http.SubscriptionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#createCheckoutSession">createCheckoutSession</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#customerPortal">customerPortal</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#retrievePlan">retrievePlan</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#webhook">webhook</a></li></ul></li><li><a href="Controllers.Http.TradeController.html">Controllers.Http.TradeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.TradeController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.UserController.html">Controllers.Http.UserController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#connexion">connexion</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forget">forget</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forgetValidation">forgetValidation</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#inscription">inscription</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#resendMail">resendMail</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#validation">validation</a></li></ul></li><li><a href="Controllers.Ws.ChatController.html">Controllers.Ws.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Ws.ChatController.html#onMessage">onMessage</a></li></ul></li><li><a href="Middleware.Authentication.html">Middleware.Authentication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.Authentication.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckJwtTimeExpiry.html">Middleware.CheckJwtTimeExpiry</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckJwtTimeExpiry.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckSubscriptionValidity.html">Middleware.CheckSubscriptionValidity</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckSubscriptionValidity.html#handle">handle</a></li></ul></li><li><a href="Models.Asset.html">Models.Asset</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Asset.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Asset.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Chat.html">Models.Chat</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Chat.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Exchange.html">Models.Exchange</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.updatedAtColumn">updatedAtColumn</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Exchange.html#.scopeHasStrategies">scopeHasStrategies</a></li><li data-type='method' style='display: none;'><a href="Models.Exchange.html#strategies">strategies</a></li></ul></li><li><a href="Models.Napoleon.html">Models.Napoleon</a></li><li><a href="Models.Setting.html">Models.Setting</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Setting.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Setting.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Strategy.html">Models.Strategy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Strategy.html#.scopeHasTrades">scopeHasTrades</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#assets">assets</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#trades">trades</a></li></ul></li><li><a href="Models.Subscription.html">Models.Subscription</a></li><li><a href="Models.Token.html">Models.Token</a></li><li><a href="Models.Trade.html">Models.Trade</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Trade.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.User.html">Models.User</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.User.html#.hidden">hidden</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.User.html#.boot">boot</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.Http.html">Controllers.Http</a></li><li><a href="Controllers.Ws.html">Controllers.Ws</a></li><li><a href="Middleware.html">Middleware</a></li><li><a href="Models.html">Models</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthentificationFailedException">AuthentificationFailedException</a></li><li><a href="global.html#connexionResponse">connexionResponse</a></li><li><a href="global.html#ctx">ctx</a></li><li><a href="global.html#currencyByDay">currencyByDay</a></li><li><a href="global.html#customerPortalError">customerPortalError</a></li><li><a href="global.html#customerPortalErrorDetail">customerPortalErrorDetail</a></li><li><a href="global.html#enoughData">enoughData</a></li><li><a href="global.html#exchange">exchange</a></li><li><a href="global.html#exchanges">exchanges</a></li><li><a href="global.html#formValidationFailed">formValidationFailed</a></li><li><a href="global.html#formValidationMDetails">formValidationMDetails</a></li><li><a href="global.html#isActive">isActive</a></li><li><a href="global.html#messages">messages</a></li><li><a href="global.html#napoleon">napoleon</a></li><li><a href="global.html#performance">performance</a></li><li><a href="global.html#position">position</a></li><li><a href="global.html#positions">positions</a></li><li><a href="global.html#registrationValidation">registrationValidation</a></li><li><a href="global.html#saveExchangeResponse">saveExchangeResponse</a></li><li><a href="global.html#sessionId">sessionId</a></li><li><a href="global.html#setting">setting</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#startedStrategy">startedStrategy</a></li><li><a href="global.html#startResponse">startResponse</a></li><li><a href="global.html#strategies">strategies</a></li><li><a href="global.html#strategy">strategy</a></li><li><a href="global.html#StripeCreateCheckoutSessionException">StripeCreateCheckoutSessionException</a></li><li><a href="global.html#StripeCreateCheckoutSessionExceptionDetails">StripeCreateCheckoutSessionExceptionDetails</a></li><li><a href="global.html#subscription">subscription</a></li><li><a href="global.html#subscriptionData">subscriptionData</a></li><li><a href="global.html#SubscriptionExpiryException">SubscriptionExpiryException</a></li><li><a href="global.html#success">success</a></li><li><a href="global.html#TokenExpiryException">TokenExpiryException</a></li><li><a href="global.html#tokens">tokens</a></li><li><a href="global.html#trade">trade</a></li><li><a href="global.html#urlToRedirect">urlToRedirect</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#websocketMessage">websocketMessage</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Controllers/Http/UserController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
const User = use("App/Models/User");
const Setting = use("App/Models/Setting");
const Exchange = use("App/Models/Exchange");
const Strategy = use("App/Models/Strategy");
const Napoleon = use("App/Models/Napoleon");
const Subscription = use("App/Models/Subscription");
const { validate } = use("Validator");
const Mail = use("Mail");
const Env = use("Env");
const Token = use("App/Models/Token");
const { decode } = require("jws");
const moment = require("moment");

/**
 * @memberof Controllers.Http
 * @classDesc This is the Controller for routes that begin by "[Domain name]/api/v1/user" or "[Domain name]/api/v1/login" . Desserve data related to user.
 */
class UserController {
  /**
   * @typedef {object} user
   * @property {number|string} id - User's id
   * @property {string} username - User's username
   * @property {string} email - User's mail
   * @property {string} date_of_birth - User's date of birth
   * @property {boolean} male - If the user is male
   * @property {boolean} active - If the user has validate his mail
   * @property {string} created_at - The date the user registered
   * @property {string} updated_at - The date the user update his profile
   */

  /**
   * @typedef {object} formValidationFailed
   * @property {boolean} successfully - If the validation was successful
   * @property {formValidationMDetails} details - Details about error
   * @example
   * {
   *   success: false,
   *   details: {
   *     "field":"email",
   *     "message":"Cannot find user with provided email"
   *   }
   * }
   */

  /**
   * @typedef {object} formValidationMDetails
   * @property {string} field - Error type
   * @property {string} message - Error message
   */

  /**
   * @typedef {object} registrationValidation
   * @param {boolean} success - If the registration was successful
   * @param {string} type - The response subject
   * @example
   * {
   *   success: true,
   *   type: "registration",
   * }
   */

   /**
    * @typedef {object} connexionResponse
    * @property {boolean} success - if the connection was successful 
    * @property {string} type - The response subject
    * @property {string} token - The JWT token
    * @property {number|string} userId - User's id 
    * @example
    * {
    *  success: true,
    *  type: "connexion",
    *  token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
    *  userId: 2,
    * }
    */

  /**
   * @description Gives user data
   * @param {ctx} ctx - Context object
   * @param {ctx} ctx.params.id - User's id
   * @returns {user} All user's data
   */
  async get({ params }) {
    try {
      const user = await User.find(params.id);
      return user;
    } catch (error) {
      console.log(error);
    }
  }

  /**
   * @description Update user data
   * @param {ctx} ctx - Context object
   * @param {number|string} ctx.params.id - User's id
   * @param {string} [ctx.request.email] - User's email
   * @param {string} [ctx.request.username] - User's username
   * @param {string} [ctx.request.date_of_birth] - User's date of birth
   * @param {boolean} [ctx.request.male] - If user is male
   * @returns {success} - If user has been updated successfully
   * @throws {formValidationFailed}
   */
  async update({ request, params }) {
    const { email, username } = request.all();
    const user = await User.find(params.id);

    //only if post is about username and email
    if (!(email === undefined) &amp;&amp; !(username === undefined)) {
      //rules on email apply only if the email is different from the current one
      let rules;
      if (user.email === email &amp;&amp; user.username === username) rules = {};
      else if (user.email === email &amp;&amp; user.username !== username) {
        rules = {
          username: "required|unique:users,username|min:4",
        };
      } else if (user.email !== email &amp;&amp; user.username === username) {
        rules = {
          email: "required|email|unique:users,email",
        };
      } else if (user.email !== email &amp;&amp; user.username !== username) {
        console.log(username);
        rules = {
          email: "required|email|unique:users,email",
          username: "required|unique:users,username|min:4",
        };
      }

      const messages = {
        "email.required": "Vous devez entrer un email",
        "email.email": "Cette email n'est pas valide",
        "email.unique": "Cette email existe déjà",
        "username.required": "Vous devez fournir un pseudo",
        "username.unique": "Ce pseudo est déjà utilisé",
        "username.min": "Plus de 3 charactères recquis",
      };

      const validation = await validate(request.all(), rules, messages);

      //if validation fails return error message
      if (validation.fails()) {
        return {
          success: false,
          details: { ...validation.messages()[0], type: "formValidation" },
        };
      }
    }

    //if everything is ok
    try {
      const body = request.post();
      const keys = Object.keys(body);
      keys.forEach((key) => (user[key] = body[key]));
      await user.save();
      return {
        success: true,
      };
    } catch (error) {
      return {
        success: false,
      };
    }
  }

  /**
   * @description Save user credenties for registration and send him a validation mail
   * @param {ctx} ctx - Context object
   * @param {string} ctx.request.email - User's email
   * @param {string} ctx.request.password - User's password
   * @param {string} ctx.request.username - User's username
   * @returns {registrationValidation} - Object
   * @throws {formValidationFailed}
   */
  async inscription({ request, auth }) {
    const { email, password, username } = request.all();
    const rules = {
      email: "required|email|unique:users,email",
      password: "required|min:6",
      username: "required|unique:users,username|min:4",
    };

    const messages = {
      "email.required": "Vous devez entrer un email",
      "email.email": "Cette email n'est pas valide",
      "email.unique": "Cette email existe déjà",
      "password.min": "Plus de 5 charactères recquis",
      "password.required": "Vous devez fournir un mot de passe",
      "username.required": "Vous devez fournir un pseudo",
      "username.unique": "Ce pseudo est déjà utilisé",
      "username.min": "Plus de 3 charactères recquis",
    };

    const validation = await validate(request.all(), rules, messages);

    //if validation fails return error message
    if (validation.fails()) {
      return {
        success: false,
        details: validation.messages()[0],
      };
    }

    //else mutiple table for this user are create in database
    //user table
    const user = new User();
    user.username = username;
    user.email = email;
    user.password = password;
    await user.save();

    //subscription table
    const subscription = new Subscription();
    subscription.user_id = user.id;
    subscription.date_end_subscription = moment()
      .add(1, "M")
      .format("YYYY-MM-DD");
    await subscription.save();

    //setting table
    const setting = new Setting();
    setting.user_id = user.id;
    await setting.save();

    //exchange table
    const exchange = new Exchange();
    exchange.name = "binance";
    exchange.user_id = user.id;
    await exchange.save();

    //strategy table
    //first we need Napoleon table data
    const napoleons = await Napoleon.all();
    napoleons.toJSON().map(async (napoleonStrat) => {
      const strategy = new Strategy();
      strategy.exchange_id = exchange.id;
      strategy.strategy = napoleonStrat.strategy;
      strategy.frequency = napoleonStrat.frequency;
      strategy.title = napoleonStrat.title;
      await strategy.save();
    });

    //in the mail for the user, a link with token is send to validate the user's mail
    //the link point to 'login/inscription/validation' route

    //first: we create a token and save it in database
    const { token, type } = await auth.generate(user);
    const tokenTable = new Token();
    tokenTable.type = type;
    tokenTable.token = token;
    tokenTable.user_id = user.id;
    await tokenTable.save();

    try {
      const text = `
                  &lt;h3>Bienvenue sur Trady&lt;h3>
                  &lt;p>Pour finaliser votre inscription cliquez &lt;a href='${Env.get(
                    "APP_URL"
                  )}/api/v1/login/inscription/validation/${token}'>ici&lt;/a>.&lt;br>
                      Vous serez alors redirigé vers notre site&lt;/p>
              `;

      await Mail.raw(text, (message) => {
        message.from(Env.get("MAIL_USERNAME"));
        message.to(email);
        message.subject("Inscription sur Trady");
      });
    } catch (error) {
      console.log(
        "🚀 ~ file: UserController.js ~ line 226 ~ UserController ~ inscription ~ error",
        error
      );
      return {
        success: false,
        details: {
          type: "send_email",
          message: "an error occur, email could not be sent",
        },
      };
    }
    return {
      success: true,
      type: "registration",
    };
  }

  /**
   * @description Active the user after he verify his email
   * @param {ctx} ctx - Context object
   * @param {string} ctx.params.token - The token to verify email validity
   * @param {Function} ctx.response.route - Function that redirect to an url
   * @returns {void}
   */
  async validation({ params, response }) {
    const { token } = params;
    const id = decode(token).payload.uid;
    const user = await User.find(id);
    user.active = true;
    await user.save();

    //redirection to front index
    response.route(`${Env.get("FRONT_URL")}?validation=true`);
  }

  /**
   * @description Validates the user credenties to log in
   * @param {ctx} ctx - Context object
   * @param {string} ctx.request.email - User's email
   * @param {string} ctx.request.password - User's password
   * @param {Function} ctx.auth.attempt - Create a JWT token with user id and an expiration time
   * @returns {connexionResponse} - Object
   * @throws {formValidationFailed}
   */
  async connexion({ request, auth }) {
    const { email, password } = request.all();
    //expose a token that expires in 1hour
    const { token } = await auth.attempt(email, password, {
      expireIn: 3600000,
    });
    const user = await User.findBy("email", email);
    return {
      success: true,
      type: "connexion",
      token,
      userId: user.id,
    };
  }

  /**
   * @description Verify user's email and send a mail to update his password
   * @param {ctx} ctx - Context object 
   * @param {string} ctx.request.email - User's email
   * @param {string} ctx.request.password - User's password
   * @param {boolean} ctx.request.updatePassword - Iff the  the user want update his password
   * @param {Function} ctx.auth.getUser - Find a user thanks a JWT token
   * @returns {success} - If everything went well
   * @throws {formValidationFailed}
   */
  async forget({ request, auth }) {
    const { email, password, updatePassword } = request.all();

    //only if user already verify his mail
    if (updatePassword) {
      const rules = {
        password: "required|min:6",
      };

      const messages = {
        "password.min": "Plus de 5 charactères recquis",
        "password.required": "Vous devez fournir un mot de passe",
      };

      const validation = await validate(
        { password: password },
        rules,
        messages
      );

      //if validation fails return error message
      if (validation.fails()) {
        return {
          success: false,
          details: validation.messages()[0],
        };
      }

      //get user instance by token
      const userByToken = await auth.getUser();
      //get user instance by mail
      let user;
      try {
        user = await User.findByOrFail("email", email);
      } catch (e) {
        return {
          success: false,
          details: {
            field: "email",
            message: "Ce mail n'existe pas",
          },
        };
      }

      //if mail and token do not refer to the same user
      if (userByToken.id !== user.id) {
        return { success: false };
      }

      //else we update the password
      user.password = password;
      await user.save();

      return { success: true };
    }

    //if no password present, this is the case where the user sends his email without having been verified before
    //we create a mail and send to him
    try {
      const user = await User.findByOrFail("email", email);

      //we create a user token and save it
      const { token, type } = await auth.generate(user);
      const tokenTable = await Token.findOrCreate(
        { user_id: user.id },
        { user_id: user.id }
      );
      tokenTable.token = token;
      tokenTable.type = type;
      await tokenTable.save();

      const text = `
                &lt;h3>Vous avez oublié votre mot de passe ?&lt;h3>
                &lt;p>Pour le reinitialiser cliquez sur ce &lt;a href='${Env.get(
                  "APP_URL"
                )}/api/v1/login/forget/validation/${token}'>lien&lt;/a>.&lt;br>
                    Vous serez alors redirigé vers notre site&lt;/p>
            `;

      await Mail.raw(text, (message) => {
        message.from(Env.get("MAIL_USERNAME"));
        message.to(email);
        message.subject("Trady: Mot de passe oublié");
      });

      return { success: true };
    } catch (e) {
      return {
        success: false,
        details: {
          message: "Ce mail n'existe pas",
          field: "email",
        },
      };
    }
  }

  /**
   * @description Verify the token present in users email and redirect him to login page
   * @param {ctx} ctx - Context object 
   * @param {string} ctx.params.token - Context object 
   * @param {string} ctx.response.route - Function that redirect to an url
   * @returns {void}
   */
  async forgetValidation({ params, response }) {
    const { token } = params;
    try {
      await Token.findByOrFail("token", token);
      //redirection to front index
      response.route(
        `${Env.get("FRONT_URL")}?validation=true&amp;forget=true&amp;token=${token}`
      );
    } catch (e) {
      response.route(`${Env.get("FRONT_URL")}?validation=false&amp;forget=true`);
    }
  }

  /**
   * @description Resend a registration's email to user 
   * @param {ctx} ctx - Context oject
   * @param {string} ctx.request.email - User's email
   * @returns {success} - If everything went well
   */
  async resendMail({ request }) {
    const { email } = request.all();

    //we get the token with email
    let user;
    try {
      user = await User.findByOrFail("email", email);
    } catch (e) {
      return { success: false };
    }
    const token = await Token.findBy({ user_id: user.id });
    const text = `
                &lt;h3>Bienvenue sur Trady&lt;h3>
                &lt;p>Pour finaliser votre inscription cliquez &lt;a href='${Env.get(
                  "APP_URL"
                )}/api/v1/login/inscription/validation/${
      token.token
    }'>ici&lt;/a>.&lt;br>
                    Vous serez alors redirigé vers notre site&lt;/p>
            `;

    await Mail.raw(text, (message) => {
      message.from(Env.get("MAIL_USERNAME"));
      message.to(email);
      message.subject("Inscription sur Trady");
    });

    return { success: true };
  }
}

module.exports = UserController;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Fri Feb 12 2021 11:08:35 GMT+0100 (heure normale d’Europe centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
