<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>app/Controllers/Http/AssetController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="Controllers.Http.AssetController.html">Controllers.Http.AssetController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#allDaily">allDaily</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#byStrategy">byStrategy</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#sufficient">sufficient</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#total">total</a></li></ul></li><li><a href="Controllers.Http.ChatController.html">Controllers.Http.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ChatController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.ExchangeController.html">Controllers.Http.ExchangeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#USDTBalance">USDTBalance</a></li></ul></li><li><a href="Controllers.Http.PositionController.html">Controllers.Http.PositionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#current">current</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#performance">performance</a></li></ul></li><li><a href="Controllers.Http.SettingController.html">Controllers.Http.SettingController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#post">post</a></li></ul></li><li><a href="Controllers.Http.StrategyController.html">Controllers.Http.StrategyController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#isActive">isActive</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#userStrategyInfo">userStrategyInfo</a></li></ul></li><li><a href="Controllers.Http.SubscriptionController.html">Controllers.Http.SubscriptionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#createCheckoutSession">createCheckoutSession</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#customerPortal">customerPortal</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#retrievePlan">retrievePlan</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#webhook">webhook</a></li></ul></li><li><a href="Controllers.Http.TradeController.html">Controllers.Http.TradeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.TradeController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.UserController.html">Controllers.Http.UserController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#connexion">connexion</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forget">forget</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forgetValidation">forgetValidation</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#inscription">inscription</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#resendMail">resendMail</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#validation">validation</a></li></ul></li><li><a href="Controllers.Ws.ChatController.html">Controllers.Ws.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Ws.ChatController.html#onMessage">onMessage</a></li><li data-type='method' style='display: none;'><a href="Controllers.Ws.ChatController.html#saveMessage">saveMessage</a></li></ul></li><li><a href="Exceptions.AuthentificationFailedException.html">Exceptions.AuthentificationFailedException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.AuthentificationFailedException.html#handle">handle</a></li></ul></li><li><a href="Exceptions.BinanceKeyException.html">Exceptions.BinanceKeyException</a></li><li><a href="Exceptions.StripeCreateCheckoutSessionException.html">Exceptions.StripeCreateCheckoutSessionException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.StripeCreateCheckoutSessionException.html#handle">handle</a></li></ul></li><li><a href="Exceptions.SubscriptionExpiryException.html">Exceptions.SubscriptionExpiryException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.SubscriptionExpiryException.html#handle">handle</a></li></ul></li><li><a href="Exceptions.TokenExpiryException.html">Exceptions.TokenExpiryException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.TokenExpiryException.html#handle">handle</a></li></ul></li><li><a href="Listeners.NapoleonListener.html">Listeners.NapoleonListener</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Listeners.NapoleonListener.html#.handleError">handleError</a></li><li data-type='method' style='display: none;'><a href="Listeners.NapoleonListener.html#.handleSuccess">handleSuccess</a></li></ul></li><li><a href="Middleware.Authentication.html">Middleware.Authentication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.Authentication.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckJwtTimeExpiry.html">Middleware.CheckJwtTimeExpiry</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckJwtTimeExpiry.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckSubscriptionValidity.html">Middleware.CheckSubscriptionValidity</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckSubscriptionValidity.html#handle">handle</a></li></ul></li><li><a href="Models.Asset.html">Models.Asset</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Asset.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Asset.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Chat.html">Models.Chat</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Chat.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Exchange.html">Models.Exchange</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.updatedAtColumn">updatedAtColumn</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Exchange.html#.scopeHasStrategies">scopeHasStrategies</a></li><li data-type='method' style='display: none;'><a href="Models.Exchange.html#strategies">strategies</a></li></ul></li><li><a href="Models.Napoleon.html">Models.Napoleon</a></li><li><a href="Models.Setting.html">Models.Setting</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Setting.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Setting.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Strategy.html">Models.Strategy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Strategy.html#.scopeHasTrades">scopeHasTrades</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#asset">asset</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#trades">trades</a></li></ul></li><li><a href="Models.Subscription.html">Models.Subscription</a></li><li><a href="Models.Token.html">Models.Token</a></li><li><a href="Models.Trade.html">Models.Trade</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Trade.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.User.html">Models.User</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.User.html#.hidden">hidden</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.User.html#.boot">boot</a></li></ul></li><li><a href="Task.MailTask.html">Task.MailTask</a><ul class='members'><li data-type='member' style='display: none;'><a href="Task.MailTask.html#.schedule">schedule</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Task.MailTask.html#calculateAssetDataInEur">calculateAssetDataInEur</a></li><li data-type='method' style='display: none;'><a href="Task.MailTask.html#filterAssetsOfLastTwoDays">filterAssetsOfLastTwoDays</a></li><li data-type='method' style='display: none;'><a href="Task.MailTask.html#getStratPositions">getStratPositions</a></li><li data-type='method' style='display: none;'><a href="Task.MailTask.html#handle">handle</a></li></ul></li><li><a href="Task.NapoleonTask.html">Task.NapoleonTask</a><ul class='members'><li data-type='member' style='display: none;'><a href="Task.NapoleonTask.html#.schedule">schedule</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Task.NapoleonTask.html#handle">handle</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.Http.html">Controllers.Http</a></li><li><a href="Controllers.Ws.html">Controllers.Ws</a></li><li><a href="Exceptions.html">Exceptions</a></li><li><a href="Listeners.html">Listeners</a></li><li><a href="Middleware.html">Middleware</a></li><li><a href="Models.html">Models</a></li><li><a href="Task.html">Task</a></li></ul><h3>Global</h3><ul><li><a href="global.html#assetDataShorted">assetDataShorted</a></li><li><a href="global.html#assets">assets</a></li><li><a href="global.html#AuthentificationFailedException">AuthentificationFailedException</a></li><li><a href="global.html#connexionResponse">connexionResponse</a></li><li><a href="global.html#ctx">ctx</a></li><li><a href="global.html#currencyByDay">currencyByDay</a></li><li><a href="global.html#customerPortalError">customerPortalError</a></li><li><a href="global.html#customerPortalErrorDetail">customerPortalErrorDetail</a></li><li><a href="global.html#enoughData">enoughData</a></li><li><a href="global.html#exchange">exchange</a></li><li><a href="global.html#exchanges">exchanges</a></li><li><a href="global.html#formattedAssetDataInEur">formattedAssetDataInEur</a></li><li><a href="global.html#formValidationFailed">formValidationFailed</a></li><li><a href="global.html#formValidationMDetails">formValidationMDetails</a></li><li><a href="global.html#isActive">isActive</a></li><li><a href="global.html#messages">messages</a></li><li><a href="global.html#napoleon">napoleon</a></li><li><a href="global.html#performance">performance</a></li><li><a href="global.html#position">position</a></li><li><a href="global.html#positions">positions</a></li><li><a href="global.html#registrationValidation">registrationValidation</a></li><li><a href="global.html#saveExchangeResponse">saveExchangeResponse</a></li><li><a href="global.html#sessionId">sessionId</a></li><li><a href="global.html#setting">setting</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#startedStrategy">startedStrategy</a></li><li><a href="global.html#startResponse">startResponse</a></li><li><a href="global.html#strategies">strategies</a></li><li><a href="global.html#strategy">strategy</a></li><li><a href="global.html#strategyDataShorted">strategyDataShorted</a></li><li><a href="global.html#StripeCreateCheckoutSessionException">StripeCreateCheckoutSessionException</a></li><li><a href="global.html#StripeCreateCheckoutSessionExceptionDetails">StripeCreateCheckoutSessionExceptionDetails</a></li><li><a href="global.html#subscription">subscription</a></li><li><a href="global.html#subscriptionData">subscriptionData</a></li><li><a href="global.html#SubscriptionExpiryException">SubscriptionExpiryException</a></li><li><a href="global.html#success">success</a></li><li><a href="global.html#TokenExpiryException">TokenExpiryException</a></li><li><a href="global.html#tokens">tokens</a></li><li><a href="global.html#trade">trade</a></li><li><a href="global.html#urlToRedirect">urlToRedirect</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#websocketMessage">websocketMessage</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">app/Controllers/Http/AssetController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
const User = use("App/Models/User");
const Asset = use("App/Models/Asset");
const Database = use("Database");
const Helpers = use("Helpers");
const AssetSorting = use("App/Services/AssetSorting")
const axios = require("axios").default;
const fs = require("fs");

/**
 * @namespace Controllers.Http
 */

/**
 * @memberof Controllers.Http
 * @classDesc This is the Controller for routes that begin by "[Domain name]/api/v1/assets". Desserve data related to assets.
 */
class AssetController {
  
   /**
   * @description Gives all user assets filter and sorted by day
   * @param {ctx} ctx - Context object
   * @param {number|string} ctx.params.id - User's id
   * @returns {Array&lt;currencyByDay>} Array of currencyByDay
   */
  async allDaily({ params }) {
    const assetSorting = new AssetSorting()
    const assetSortedByDay = await assetSorting.allDaily(params.id)
    return assetSortedByDay
  }

  /**
   * @description Gives user assets filter and sorted by day for one strategy
   * @param {ctx} ctx - Context object
   * @param {number|string} ctx.params.id - User's id
   * @param {string} ctx.params.strat - The title of strategy
   * @returns {Array&lt;currencyByDay>} - Array of currencyByDay
   */
  async byStrategy({ params }) {
    const userId = params.id;
    const strat = params.strat.replace("%20", " ").split("_").join("/");

    const stratByDate = await Database.select("assets.amount_by_date")
      .from("exchanges")
      .where("user_id", userId)
      .rightJoin("strategies", "strategies.exchange_id", "exchanges.id")
      .rightJoin("assets", "assets.strategy_id", "strategies.id")
      .where("strategies.title", strat);

    /**
     * TODO: handle case multi exchange
     */
    if (stratByDate.length > 1) return stratByDate;

    return stratByDate[0].amount_by_date;
  }

  /**
   * @description Gives all user strategies
   * @param {ctx} ctx - Context object
   * @param {number|string} ctx.params.id - User's id
   * @returns {Array&lt;strategy>} - Array of strategies
   */
  async total({ params }) {
    //get user's data
    let user = await User.query()
      .where("id", params.id)
      .with("exchanges.strategies")
      .fetch();
    user = user.toJSON();

    //push all strategy by exchange to "strats"
    const strats = [];
    user[0].exchanges.map((exchange) => {
      exchange.strategies.map((strategy) => {
        strats.push(strategy);
      });
    });
    return strats;
  }

  /**
   * @description Inform if the user had enough data (above 1), useful for displaying or not the graph
   * @param {ctx} ctx - Context object
   * @param {number|string} ctx.params.id - User's id
   * @returns {enoughData} - Object
   */
  async sufficient({ params }) {
    const userId = params.id;
    const assets = await Database.select("amount_by_date")
      .table("assets")
      .rightJoin("strategies", "strategy_id", "strategies.id")
      .rightJoin("exchanges", "exchange_id", "exchanges.id")
      .rightJoin("users", "user_id", "users.id")
      .where("users.id", userId);

    let enoughDatas = false;
    assets.forEach((asset) => {
      const amounts = JSON.parse(asset.amount_by_date);
      if (amounts &amp;&amp; amounts.length > 1) enoughDatas = true;
    });

    return { enoughDatas };
  }

  async test(pair) {
    async function getAvgPrice(pair, limit) {
      const datas = await axios.get(
        `https://api.binance.com/api/v3/klines?symbol=${pair}&amp;interval=1d&amp;limit=${limit}`
      );
      const dataFormated = datas.data.map((data) => {
        return {
          day: new Date(data[6]).toISOString(),
          avgPrice: (Number(data[1]) + Number(data[4])) / 2,
        };
      });
      return dataFormated;
    }

    function convert(base, output, isBase) {
      if (isBase) return base * output;
      else return base / output;
    }

    const ETHPrices = await getAvgPrice("ETHBTC", 100);
    const USDTPrices = await getAvgPrice("BTCUSDT", 100);

    let data = fs.readFileSync(`${Helpers.appRoot()}/data.json`);
    data = JSON.parse(data);
    const snapshots = data.snapshotVos;

    const formatData = snapshots.map((snap) => {
      const ETHObj = ETHPrices.find((obj) => {
        return (
          obj.day.substring(0, 10) ===
          new Date(snap.updateTime).toISOString().substring(0, 10)
        );
      });
      const USDTObj = USDTPrices.find((obj) => {
        return (
          obj.day.substring(0, 10) ===
          new Date(snap.updateTime).toISOString().substring(0, 10)
        );
      });

      return {
        date: new Date(snap.updateTime).toISOString(),
        BTC: snap.data.totalAssetOfBtc,
        ETH: convert(snap.data.totalAssetOfBtc, ETHObj.avgPrice, false),
        USDT: convert(snap.data.totalAssetOfBtc, USDTObj.avgPrice, true),
      };
    });
    const asset = await Asset.findOrCreate(
      { id: 1 },
      {
        id: 1,
        amount_by_date: JSON.stringify(formatData),
      }
    );
    asset.strategy_id = 1;
    asset.amount_by_date = JSON.stringify(formatData);
    await asset.save();
  }
}

module.exports = AssetController;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Tue Feb 16 2021 10:14:26 GMT+0100 (heure normale d’Europe centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
