<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>app/Tasks/MailTask.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="Controllers.Http.AssetController.html">Controllers.Http.AssetController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#allDaily">allDaily</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#byStrategy">byStrategy</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#sufficient">sufficient</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#total">total</a></li></ul></li><li><a href="Controllers.Http.ChatController.html">Controllers.Http.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ChatController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.ExchangeController.html">Controllers.Http.ExchangeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#USDTBalance">USDTBalance</a></li></ul></li><li><a href="Controllers.Http.PositionController.html">Controllers.Http.PositionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#current">current</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#performance">performance</a></li></ul></li><li><a href="Controllers.Http.SettingController.html">Controllers.Http.SettingController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#post">post</a></li></ul></li><li><a href="Controllers.Http.StrategyController.html">Controllers.Http.StrategyController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#isActive">isActive</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#userStrategyInfo">userStrategyInfo</a></li></ul></li><li><a href="Controllers.Http.SubscriptionController.html">Controllers.Http.SubscriptionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#createCheckoutSession">createCheckoutSession</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#customerPortal">customerPortal</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#retrievePlan">retrievePlan</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#webhook">webhook</a></li></ul></li><li><a href="Controllers.Http.TradeController.html">Controllers.Http.TradeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.TradeController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.UserController.html">Controllers.Http.UserController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#connexion">connexion</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forget">forget</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forgetValidation">forgetValidation</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#inscription">inscription</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#resendMail">resendMail</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#validation">validation</a></li></ul></li><li><a href="Controllers.Ws.ChatController.html">Controllers.Ws.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Ws.ChatController.html#onMessage">onMessage</a></li><li data-type='method' style='display: none;'><a href="Controllers.Ws.ChatController.html#saveMessage">saveMessage</a></li></ul></li><li><a href="Exceptions.AuthentificationFailedException.html">Exceptions.AuthentificationFailedException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.AuthentificationFailedException.html#handle">handle</a></li></ul></li><li><a href="Exceptions.BinanceKeyException.html">Exceptions.BinanceKeyException</a></li><li><a href="Exceptions.StripeCreateCheckoutSessionException.html">Exceptions.StripeCreateCheckoutSessionException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.StripeCreateCheckoutSessionException.html#handle">handle</a></li></ul></li><li><a href="Exceptions.SubscriptionExpiryException.html">Exceptions.SubscriptionExpiryException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.SubscriptionExpiryException.html#handle">handle</a></li></ul></li><li><a href="Exceptions.TokenExpiryException.html">Exceptions.TokenExpiryException</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Exceptions.TokenExpiryException.html#handle">handle</a></li></ul></li><li><a href="Listeners.NapoleonListener.html">Listeners.NapoleonListener</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Listeners.NapoleonListener.html#.handleError">handleError</a></li><li data-type='method' style='display: none;'><a href="Listeners.NapoleonListener.html#.handleSuccess">handleSuccess</a></li></ul></li><li><a href="Middleware.Authentication.html">Middleware.Authentication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.Authentication.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckJwtTimeExpiry.html">Middleware.CheckJwtTimeExpiry</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckJwtTimeExpiry.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckSubscriptionValidity.html">Middleware.CheckSubscriptionValidity</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckSubscriptionValidity.html#handle">handle</a></li></ul></li><li><a href="Models.Asset.html">Models.Asset</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Asset.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Asset.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Chat.html">Models.Chat</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Chat.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Exchange.html">Models.Exchange</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.updatedAtColumn">updatedAtColumn</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Exchange.html#.scopeHasStrategies">scopeHasStrategies</a></li><li data-type='method' style='display: none;'><a href="Models.Exchange.html#strategies">strategies</a></li></ul></li><li><a href="Models.Napoleon.html">Models.Napoleon</a></li><li><a href="Models.Setting.html">Models.Setting</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Setting.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Setting.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Strategy.html">Models.Strategy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Strategy.html#.scopeHasTrades">scopeHasTrades</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#asset">asset</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#trades">trades</a></li></ul></li><li><a href="Models.Subscription.html">Models.Subscription</a></li><li><a href="Models.Token.html">Models.Token</a></li><li><a href="Models.Trade.html">Models.Trade</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Trade.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.User.html">Models.User</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.User.html#.hidden">hidden</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.User.html#.boot">boot</a></li></ul></li><li><a href="Task.MailTask.html">Task.MailTask</a><ul class='members'><li data-type='member' style='display: none;'><a href="Task.MailTask.html#.schedule">schedule</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Task.MailTask.html#calculateAssetDataInEur">calculateAssetDataInEur</a></li><li data-type='method' style='display: none;'><a href="Task.MailTask.html#filterAssetsOfLastTwoDays">filterAssetsOfLastTwoDays</a></li><li data-type='method' style='display: none;'><a href="Task.MailTask.html#getStratPositions">getStratPositions</a></li><li data-type='method' style='display: none;'><a href="Task.MailTask.html#handle">handle</a></li></ul></li><li><a href="Task.NapoleonTask.html">Task.NapoleonTask</a><ul class='members'><li data-type='member' style='display: none;'><a href="Task.NapoleonTask.html#.schedule">schedule</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Task.NapoleonTask.html#handle">handle</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.Http.html">Controllers.Http</a></li><li><a href="Controllers.Ws.html">Controllers.Ws</a></li><li><a href="Exceptions.html">Exceptions</a></li><li><a href="Listeners.html">Listeners</a></li><li><a href="Middleware.html">Middleware</a></li><li><a href="Models.html">Models</a></li><li><a href="Task.html">Task</a></li></ul><h3>Global</h3><ul><li><a href="global.html#assetDataShorted">assetDataShorted</a></li><li><a href="global.html#assets">assets</a></li><li><a href="global.html#AuthentificationFailedException">AuthentificationFailedException</a></li><li><a href="global.html#connexionResponse">connexionResponse</a></li><li><a href="global.html#ctx">ctx</a></li><li><a href="global.html#currencyByDay">currencyByDay</a></li><li><a href="global.html#customerPortalError">customerPortalError</a></li><li><a href="global.html#customerPortalErrorDetail">customerPortalErrorDetail</a></li><li><a href="global.html#enoughData">enoughData</a></li><li><a href="global.html#exchange">exchange</a></li><li><a href="global.html#exchanges">exchanges</a></li><li><a href="global.html#formattedAssetDataInEur">formattedAssetDataInEur</a></li><li><a href="global.html#formValidationFailed">formValidationFailed</a></li><li><a href="global.html#formValidationMDetails">formValidationMDetails</a></li><li><a href="global.html#isActive">isActive</a></li><li><a href="global.html#messages">messages</a></li><li><a href="global.html#napoleon">napoleon</a></li><li><a href="global.html#performance">performance</a></li><li><a href="global.html#position">position</a></li><li><a href="global.html#positions">positions</a></li><li><a href="global.html#registrationValidation">registrationValidation</a></li><li><a href="global.html#saveExchangeResponse">saveExchangeResponse</a></li><li><a href="global.html#sessionId">sessionId</a></li><li><a href="global.html#setting">setting</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#startedStrategy">startedStrategy</a></li><li><a href="global.html#startResponse">startResponse</a></li><li><a href="global.html#strategies">strategies</a></li><li><a href="global.html#strategy">strategy</a></li><li><a href="global.html#strategyDataShorted">strategyDataShorted</a></li><li><a href="global.html#StripeCreateCheckoutSessionException">StripeCreateCheckoutSessionException</a></li><li><a href="global.html#StripeCreateCheckoutSessionExceptionDetails">StripeCreateCheckoutSessionExceptionDetails</a></li><li><a href="global.html#subscription">subscription</a></li><li><a href="global.html#subscriptionData">subscriptionData</a></li><li><a href="global.html#SubscriptionExpiryException">SubscriptionExpiryException</a></li><li><a href="global.html#success">success</a></li><li><a href="global.html#TokenExpiryException">TokenExpiryException</a></li><li><a href="global.html#tokens">tokens</a></li><li><a href="global.html#trade">trade</a></li><li><a href="global.html#urlToRedirect">urlToRedirect</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#websocketMessage">websocketMessage</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">app/Tasks/MailTask.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
const AssetSorting = use("App/Services/AssetSorting");
const Task = use("Task");
const User = use("App/Models/User");
const Mail = use("Mail");
const Env = use("Env");
const axios = require("axios");
const moment = require("moment");
moment.locale('fr', {
  months : 'janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre'.split('_'),
  monthsShort : 'janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.'.split('_'),
  monthsParseExact : true,
  weekdays : 'dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi'.split('_'),
  weekdaysShort : 'dim._lun._mar._mer._jeu._ven._sam.'.split('_'),
  weekdaysMin : 'Di_Lu_Ma_Me_Je_Ve_Sa'.split('_'),
  weekdaysParseExact : true,
  longDateFormat : {
      LT : 'HH:mm',
      LTS : 'HH:mm:ss',
      L : 'DD/MM/YYYY',
      LL : 'D MMMM YYYY',
      LLL : 'D MMMM YYYY HH:mm',
      LLLL : 'dddd D MMMM YYYY HH:mm'
  },
  calendar : {
      sameDay : '[Aujourd’hui à] LT',
      nextDay : '[Demain à] LT',
      nextWeek : 'dddd [à] LT',
      lastDay : '[Hier à] LT',
      lastWeek : 'dddd [dernier à] LT',
      sameElse : 'L'
  },
  relativeTime : {
      future : 'dans %s',
      past : 'il y a %s',
      s : 'quelques secondes',
      m : 'une minute',
      mm : '%d minutes',
      h : 'une heure',
      hh : '%d heures',
      d : 'un jour',
      dd : '%d jours',
      M : 'un mois',
      MM : '%d mois',
      y : 'un an',
      yy : '%d ans'
  },
  dayOfMonthOrdinalParse : /\d{1,2}(er|e)/,
  ordinal : function (number) {
      return number + (number === 1 ? 'er' : 'e');
  },
  meridiemParse : /PD|MD/,
  isPM : function (input) {
      return input.charAt(0) === 'M';
  },
  // In case the meridiem units are not separated around 12, then implement
  // this function (look at locale/id.js for an example).
  // meridiemHour : function (hour, meridiem) {
  //     return /* 0-23 hour, given meridiem token and hour 1-12 */ ;
  // },
  meridiem : function (hours, minutes, isLower) {
      return hours &lt; 12 ? 'PD' : 'MD';
  },
  week : {
      dow : 1, // Monday is the first day of the week.
      doy : 4  // Used to determine first week of the year.
  }
});

/**
 * @namespace Task
 */

/**
 * @memberof Task
 * @extends Task
 * @description Check all 15 minutes whether to send the daily email to users who have subscribed and send email if time matches for a user
 */
class MailTask extends Task {
  /**
   * @description A cron job that trigger MailTask.handle() all 15 minutes
   */
  static get schedule() {
    // return "*/15 * * * *";
    return "*/10 * * * * *";
  }

  /**
   * @description Function triggered all 15 minutes, send a mail if time matches with mail time settings
   * @returns {void}
   */
  async handle() {
    try {
      console.log("start");
      const date = new Date(Date.now());
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const time = [hours, minutes, "00"].join(":");

      let users = await User.query()
        .whereHas("setting", (builder) => {
          builder.where("send_mail", true);
          // builder.where("mail_time", time);
        })
        .whereHas("strategies", (builder) => {
          builder.where("active", true);
        })
        .with("strategies", (builder) => {
          builder.where("active", true);
        })
        .with("exchanges", (builder) => {
          builder.where("name", "binance");
        })
        .with("strategies.asset")
        .with("strategies.trades")

        .fetch();
      users = users.toJSON();

      if (users.length) {
        users.forEach(async (user) => {
          // console.log(user);
          const {
            priceProgressionFormatted,
            currentWalletFormatted,
            priceProgressionInPercentFormatted,
          } = await this.calculateAssetDataInEur(user);
          const stratPositions = await this.getStratPositions(user.strategies);
          const trades = await this.getTrades(user.strategies);

          // Mail.send('daily-mail', {
          //   priceProgressionFormatted,
          //   currentWalletFormatted,
          //   priceProgressionInPercentFormatted,
          //   stratPositions,
          //   trades,
          //   date: moment().local('fr').format('dddd D MMMM YYYY'),
          //   frontUrl: Env.get('FRONT_URL')
          // }, (message) => {
          //   message.from(Env.get("MAIL_USERNAME"));
          //   message.to(user.email);
          // });
        });
      }
      console.log("end");
    } catch (e) {
      console.log(e);
    }
  }

  /**
   * @description Function that calculate from yesterday the progression of total wallet amount in euro, the total wallet amount in euro and the progression of wallet in percent
   * @returns {formattedAssetDataInEur}
   */
  async calculateAssetDataInEur(user) {
    //get rates EUR/USDT pair on Binance API
    const ratesData = await axios.get(
      "https://api.binance.com/api/v3/avgPrice?symbol=EURUSDT"
    );
    this.EurUsdtRates = ratesData.data.price

    //calculate price progression in one day in Eur
    const lastTwoDaysAsset = await this.filterAssetsOfLastTwoDays(user);
    const priceProgressionInUsdt =
      lastTwoDaysAsset[1].USDT - lastTwoDaysAsset[0].USDT;
    const priceProgressionInEur = priceProgressionInUsdt / this.EurUsdtRates;
    //remove digits after dots
    const priceProgressionFormatted = String(priceProgressionInEur).split(
      "."
    )[0];

    //calculate price progression in one day in percent
    const priceProgressionInPercent =
      (priceProgressionInUsdt / lastTwoDaysAsset[0].USDT) * 100;
    const priceProgressionInPercentString = String(priceProgressionInPercent);
    const priceProgressionInPercentBeforeDot = priceProgressionInPercentString.split(
      "."
    )[0];
    const priceProgressionInPercentAfterDot = priceProgressionInPercentString.split(
      "."
    )[1];
    const priceProgressionInPercentFormatted =
      priceProgressionInPercentBeforeDot +
      "." +
      priceProgressionInPercentAfterDot.substring(0, 2);

    //calculate current price of wallet in Eur
    const currentWalletInEur = lastTwoDaysAsset[1].USDT / this.EurUsdtRates;
    const currentWalletFormatted = String(currentWalletInEur).split(".")[0];

    return {
      priceProgressionFormatted,
      currentWalletFormatted,
      priceProgressionInPercentFormatted,
    };
  }

  /**
   * @description Return asset data of last two days
   * @returns {Array&lt;assetDataShorted>}
   */
  async filterAssetsOfLastTwoDays(user) {
    const assetSorting = new AssetSorting();
    const assetSortedByDay = await assetSorting.allDaily(user.id);
    const lastTwoDays = assetSortedByDay.slice(-2);
    return lastTwoDays;
  }

  /**
   * @description Return data of active strategy
   * @returns {Array&lt;strategyDataShorted>}
   */
  async getStratPositions(strategies) {
    const strategiesFormatted = strategies.map((strategy) => {
      const position = JSON.parse(strategy.position);
      for (const currency in position) {
        position[currency] = position[currency] * 100 + " %";
      }
      return {
        title: strategy.title,
        position,
      };
    });
    console.log(strategiesFormatted);
    return strategiesFormatted;
  }

  async getTrades(strategies) {
    const tradesPromise = strategies.map(async (strategy) => {
      const [todayTrade] = strategy.trades.filter(trade => {
        return moment(trade.created_at).isSame(Date.now(), 'day')
      })
      if(!todayTrade) {
        return {
          strategyTitle: strategy.title,
          tradeExist: false
        };
      }

      const baseCurrency = todayTrade.pair.slice(0, 3)
      const secondaryCurrency = todayTrade.pair.slice(3)

      //get the rate of usdt/currency exchanged
      const {data} = await axios.get(
        `https://api.binance.com/api/v3/avgPrice?symbol=${baseCurrency}USDT`
      );
      const ratesData = data.price
      const amountCurrencyExchangedInUsdt = todayTrade.amount * ratesData
      const amountCurrencyExchangedInEur = amountCurrencyExchangedInUsdt / this.EurUsdtRates

      return {
        strategyTitle: strategy.title,
        tradeExist: true,
        currencySell: todayTrade.action === 'BUY' ? secondaryCurrency : baseCurrency,
        currencyBuy: todayTrade.action === 'BUY' ? baseCurrency : secondaryCurrency,
        amount: String(amountCurrencyExchangedInEur).split('.')[0] + ' €'
      };
    });
    const trades = await Promise.all(tradesPromise)
    return trades
  }
}

module.exports = MailTask;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Tue Feb 16 2021 10:14:26 GMT+0100 (heure normale d’Europe centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
