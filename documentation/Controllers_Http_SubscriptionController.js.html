<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Controllers/Http/SubscriptionController.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/your-github-username/pet-adoption-center-sdk" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="Controllers.Http.AssetController.html">Controllers.Http.AssetController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#allDaily">allDaily</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#byStrategy">byStrategy</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#sufficient">sufficient</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.AssetController.html#total">total</a></li></ul></li><li><a href="Controllers.Http.ChatController.html">Controllers.Http.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ChatController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.ExchangeController.html">Controllers.Http.ExchangeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#info">info</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.ExchangeController.html#USDTBalance">USDTBalance</a></li></ul></li><li><a href="Controllers.Http.PositionController.html">Controllers.Http.PositionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#current">current</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.PositionController.html#performance">performance</a></li></ul></li><li><a href="Controllers.Http.SettingController.html">Controllers.Http.SettingController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SettingController.html#post">post</a></li></ul></li><li><a href="Controllers.Http.StrategyController.html">Controllers.Http.StrategyController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#isActive">isActive</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.StrategyController.html#userStrategyInfo">userStrategyInfo</a></li></ul></li><li><a href="Controllers.Http.SubscriptionController.html">Controllers.Http.SubscriptionController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#createCheckoutSession">createCheckoutSession</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#customerPortal">customerPortal</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#index">index</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#retrievePlan">retrievePlan</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.SubscriptionController.html#webhook">webhook</a></li></ul></li><li><a href="Controllers.Http.TradeController.html">Controllers.Http.TradeController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.TradeController.html#all">all</a></li></ul></li><li><a href="Controllers.Http.UserController.html">Controllers.Http.UserController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#connexion">connexion</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forget">forget</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#forgetValidation">forgetValidation</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#inscription">inscription</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#resendMail">resendMail</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Controllers.Http.UserController.html#validation">validation</a></li></ul></li><li><a href="Controllers.Ws.ChatController.html">Controllers.Ws.ChatController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.Ws.ChatController.html#onMessage">onMessage</a></li></ul></li><li><a href="Middleware.Authentication.html">Middleware.Authentication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.Authentication.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckJwtTimeExpiry.html">Middleware.CheckJwtTimeExpiry</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckJwtTimeExpiry.html#handle">handle</a></li></ul></li><li><a href="Middleware.CheckSubscriptionValidity.html">Middleware.CheckSubscriptionValidity</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.CheckSubscriptionValidity.html#handle">handle</a></li></ul></li><li><a href="Models.Asset.html">Models.Asset</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Asset.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Asset.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Chat.html">Models.Chat</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Chat.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Exchange.html">Models.Exchange</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Exchange.html#.updatedAtColumn">updatedAtColumn</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Exchange.html#.scopeHasStrategies">scopeHasStrategies</a></li><li data-type='method' style='display: none;'><a href="Models.Exchange.html#strategies">strategies</a></li></ul></li><li><a href="Models.Napoleon.html">Models.Napoleon</a></li><li><a href="Models.Setting.html">Models.Setting</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Setting.html#.createdAtColumn">createdAtColumn</a></li><li data-type='member' style='display: none;'><a href="Models.Setting.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.Strategy.html">Models.Strategy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.Strategy.html#.scopeHasTrades">scopeHasTrades</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#assets">assets</a></li><li data-type='method' style='display: none;'><a href="Models.Strategy.html#trades">trades</a></li></ul></li><li><a href="Models.Subscription.html">Models.Subscription</a></li><li><a href="Models.Token.html">Models.Token</a></li><li><a href="Models.Trade.html">Models.Trade</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.Trade.html#.updatedAtColumn">updatedAtColumn</a></li></ul></li><li><a href="Models.User.html">Models.User</a><ul class='members'><li data-type='member' style='display: none;'><a href="Models.User.html#.hidden">hidden</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Models.User.html#.boot">boot</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.Http.html">Controllers.Http</a></li><li><a href="Controllers.Ws.html">Controllers.Ws</a></li><li><a href="Middleware.html">Middleware</a></li><li><a href="Models.html">Models</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthentificationFailedException">AuthentificationFailedException</a></li><li><a href="global.html#connexionResponse">connexionResponse</a></li><li><a href="global.html#ctx">ctx</a></li><li><a href="global.html#currencyByDay">currencyByDay</a></li><li><a href="global.html#customerPortalError">customerPortalError</a></li><li><a href="global.html#customerPortalErrorDetail">customerPortalErrorDetail</a></li><li><a href="global.html#enoughData">enoughData</a></li><li><a href="global.html#exchange">exchange</a></li><li><a href="global.html#exchanges">exchanges</a></li><li><a href="global.html#formValidationFailed">formValidationFailed</a></li><li><a href="global.html#formValidationMDetails">formValidationMDetails</a></li><li><a href="global.html#isActive">isActive</a></li><li><a href="global.html#messages">messages</a></li><li><a href="global.html#napoleon">napoleon</a></li><li><a href="global.html#performance">performance</a></li><li><a href="global.html#position">position</a></li><li><a href="global.html#positions">positions</a></li><li><a href="global.html#registrationValidation">registrationValidation</a></li><li><a href="global.html#saveExchangeResponse">saveExchangeResponse</a></li><li><a href="global.html#sessionId">sessionId</a></li><li><a href="global.html#setting">setting</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#startedStrategy">startedStrategy</a></li><li><a href="global.html#startResponse">startResponse</a></li><li><a href="global.html#strategies">strategies</a></li><li><a href="global.html#strategy">strategy</a></li><li><a href="global.html#StripeCreateCheckoutSessionException">StripeCreateCheckoutSessionException</a></li><li><a href="global.html#StripeCreateCheckoutSessionExceptionDetails">StripeCreateCheckoutSessionExceptionDetails</a></li><li><a href="global.html#subscription">subscription</a></li><li><a href="global.html#subscriptionData">subscriptionData</a></li><li><a href="global.html#SubscriptionExpiryException">SubscriptionExpiryException</a></li><li><a href="global.html#success">success</a></li><li><a href="global.html#TokenExpiryException">TokenExpiryException</a></li><li><a href="global.html#tokens">tokens</a></li><li><a href="global.html#trade">trade</a></li><li><a href="global.html#urlToRedirect">urlToRedirect</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#websocketMessage">websocketMessage</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Controllers/Http/SubscriptionController.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
const Subscription = use("App/Models/Subscription");
const User = use("App/Models/User");
const Stripe = require("stripe");
const Env = use("Env");
const StripeCreateCheckoutSessionException = use(
  "App/Exceptions/StripeCreateCheckoutSessionException"
);
const moment = require("moment");


/**
 * @memberof Controllers.Http
 * @classDesc This is the Controller for routes that begin by "[Domain name]/api/v1/subscription". Desserve data related to subscription.
 */
class SubscriptionController {

  /**
   * 
   * @typedef {object} subscriptionData
   * @property {number} id - Subscription id 
   * @property {number} user_id - User's id of this subscription
   * @property {boolean} tester - if the subscription is still in the test period 
   * @property {strind} date_end_subscription - The date that subscription end
   * @property {strind} type - The type of subscription "bronze", "argent" or "or"
   * @property {string} customerId - The customer id to use withe stripe
   * @property {string} created_at - The start date of the subscription
   * @property {string} updated_at - the subscription update date 
   */

   /**
    * @typedef {object} sessionId
    * @property {number|string} sessionId - The id of stripe's session 
    */

    /**
    * @typedef {object} urlToRedirect
    * @property {string} urlToRedirect - The URL to redirect to 
    */

    /**
   * @typedef {object}  customerPortalErrorDetail
   * @property {string} type  - stripe
   * @property {string} message  - stripe connection error
   */

  /**
   * @typedef {object} customerPortalError
   * @property {boolean} success - If the session with the Stripe portal is opened successfully
   * @property {customerPortalErrorDetail} details - Details about errors
   * @example
   * {
   *    success: false,
   *    details: {
   *      type: "stripe",
   *      message: "stripe connection error",
   *    }
   * }
   */

  /**
   * @description Desserve all data about user's subscription
   * @param {ctx} ctx - Context object 
   * @param {number|string} ctx.params.id - User's id 
   * @returns {subscriptionData} - All data about user's subscription
   */
  async index({ params }) {
    const userId = params.id;
    const subscription = await Subscription.findBy("user_id", userId);
    return subscription;
  }

  /**
   * @description create a stripe session to subscribe and redirect the user to stripe interface
   * @param {ctx} ctx - Context object
   * @param {number|string} ctx.params.id - User's id
   * @param {number|string} ctx.request.priceId - Price's id 
   * @returns {sessionId} - The id of stripe's session  
   * @throws {StripeCreateCheckoutSessionException} - If an error was occur
   */
  async createCheckoutSession({ request, params }) {
    const { priceId } = request.all();
    const { id } = params;
    const user = await User.find(id);
    //create a session to Stripe
    const stripe = Stripe(Env.get("STRIPE_SECRET_KEY"));

    try {
      const session = await stripe.checkout.sessions.create({
        customer_email: user.email,
        mode: "subscription",
        payment_method_types: ["card"],
        line_items: [
          {
            price: priceId,
            // For metered billing, do not pass quantity
            quantity: 1,
          },
        ],
        mode: "subscription",
        // {CHECKOUT_SESSION_ID} is a string literal; do not change it!
        // the actual Session ID is returned in the query parameter when your customer
        // is redirected to the success page.
        success_url: `${Env.get(
          "FRONT_URL"
        )}console/abonnement/succes?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${Env.get("FRONT_URL")}console/abonnement`,
      });

      return {
        sessionId: session.id,
      };
    } catch (e) {
      throw new StripeCreateCheckoutSessionException();
    }
  }

  /**
   * @description Open a stripe session to handle a user subscription and redirect the user to stripe interface
   * @param {ctx} ctx - Context object 
   * @param {number|string} ctx.params.id - User's id
   * @returns {urlToRedirect} - The URL to redirect to
   * @throws {customerPortalError} - If an error was occur
   */
  async customerPortal({ params }) {
    //create a session to Stripe
    const stripe = Stripe(Env.get("STRIPE_SECRET_KEY"));
    const userId = params.id;

    try {
      const subscription = await Subscription.findByOrFail("user_id", userId);
      const portalsession = await stripe.billingPortal.sessions.create({
        customer: subscription.customerId,
        return_url: `${Env.get("FRONT_URL")}console/abonnement`,
      });

      return { urlToRedirect: portalsession.url };
    } catch (e) {
      return {
        success: false,
        details: {
          type: 'stripe',
          message: "stripe connection error",
        },
      };
    }
  }

  /**
   * @description - Handle event send by stripe about subscription
   * @param {ctx} ctx - Context object
   * @param {string} ctx.request.stripe_signature - The stripe signature
   * @param {Function} ctx.response.ok - Function to send a http response with a status 200
   * @returns {void} - Return a http response with status 200 enough content
   */
  async webhook({ request, response }) {
    const endpointSecret = Env.get("STRIPE_SIGNATURE_HEADER");
    const signature = request.header("stripe-signature");
    const stripe = Stripe(Env.get("STRIPE_SECRET_KEY"));

    //verify the good signature of event
    let event;
    try {
      event = stripe.webhooks.constructEvent(
        request.raw(),
        signature,
        endpointSecret
      );
    } catch (err) {
      console.log(`⚠️  Webhook signature verification failed.`, err.message);
      return response.ok();
    }

    switch (event.type) {
      case "invoice.paid":
        try {
          const plan = this.retrievePlan(event.data.object.lines.data[0].price.product);
          const user = await User.findByOrFail(
            "email",
            event.data.object.customer_email
          );
          const subscription = await Subscription.findByOrFail(
            "user_id",
            user.id
          );
          subscription.tester = false;
          subscription.date_end_subscription = moment().add(1, 'M').format('YYYY-MM-DD');
          subscription.type = plan;
          subscription.customerId = event.data.object.customer;
          await subscription.save();
        } catch (e) {
          console.log(e);
          return response.ok();
        }
        break;
      case "customer.subscription.updated":
        try {
          const plan = this.retrievePlan(event.data.object.plan.product);
          const subscription = await Subscription.findByOrFail('customerId', event.data.object.customer)
          subscription.type = plan;
          await subscription.save();
        } catch (e) {
          console.log(e);
          return response.ok();
        }
        break;
      default:
        console.log(`Unhandled event type ${event.type}`);
    }

    return response.ok();
  }


  /**
   * @description Take a product id and return the subscription's type
   * @param {string} productId - The product id
   * @returns {string} - The type of subscription
   */
  retrievePlan(productId) {
    let type;
    switch (productId) {
      case "prod_InJ7mgOxHQALRF":
        type = "bronze";
        break;
      case "prod_InJ7wXjzTFDZfl":
        type = "argent";
        break;
      case "prod_InJ8WauKXdADOn":
        type = "or";
        break;
      default:
        throw new Error(
          `product Id ${productId} doesn't exist.`
        );
    }
    return type;
  }
}

module.exports = SubscriptionController;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Fri Feb 12 2021 11:08:35 GMT+0100 (heure normale d’Europe centrale) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
